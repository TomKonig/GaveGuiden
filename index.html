<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Den Rette Gave - Find den perfekte gave</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="./assets/favicon.ico" type="image/x-icon">
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8 flex flex-col min-h-screen">
        <header class="flex justify-between items-center mb-8">
            <a href="/" class="flex items-center gap-3 text-2xl md:text-3xl font-bold text-slate-700 hover:text-slate-900 transition-colors">
                <img src="./assets/logo.jpeg" alt="Den Rette Gave Logo" class="h-10 w-10 rounded-md">
                <span>Den Rette Gave</span>
            </a>
            <nav>
                <button id="how-it-works-btn" class="text-slate-600 hover:text-slate-900 font-semibold">Sådan fungerer det</button>
            </nav>
        </header>

        <div class="flex-grow">
             <main id="landing-view" class="view active text-center">
                <div class="py-12 md:py-24">
                    <h2 class="text-4xl md:text-6xl font-bold mb-4">Find den perfekte gave. Hver gang.</h2>
                    <p class="text-lg md:text-xl text-slate-600 max-w-2xl mx-auto mb-8">Vores smarte quiz stiller et par simple spørgsmål for at finde personlige gaveidéer til hvem som helst.</p>
                    <button id="start-quiz-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-lg hover:bg-blue-700 transition-colors shadow-lg hover:shadow-xl">Start Guiden</button>
                </div>
            </main>
    
            <main id="quiz-view" class="view">
                 <div id="quiz-container" class="relative pt-8">
                    <h3 id="question-title" class="text-2xl md:text-3xl font-bold text-center mb-2"></h3>
                     <p id="question-text" class="text-lg text-slate-600 text-center mb-8"></p>
                     <div id="answers-container"></div>
                </div>
                 <div class="mt-8 text-center">
                    <button id="early-exit-btn" class="mt-4 text-slate-500 hover:text-slate-800 text-sm hidden">Er du i tvivl? Vis mig de bedste forslag nu</button>
                </div>
            </main>
    
            <main id="results-view" class="view">
                 <div class="py-12">
                    <h2 id="results-title" class="text-3xl md:text-4xl font-bold mb-4 text-center">Vi fandt den perfekte gave!</h2>
                    <div id="results-container" class="space-y-8"></div>
                     <div class="text-center">
                        <button id="restart-quiz-btn" class="mt-8 bg-slate-600 text-white font-bold py-3 px-8 rounded-lg text-lg hover:bg-slate-700 transition-colors">Start forfra</button>
                     </div>
                </div>
            </main>
        </div>

        <footer class="text-center text-slate-500 mt-16 py-4 border-t border-slate-200">
            <div class="flex flex-col md:flex-row md:flex-nowrap justify-center items-center gap-2 md:gap-4">
                <span class="whitespace-nowrap">&copy; 2025 Den Rette Gave (CVR: [Dit CVR-nummer])</span>
                <span class="hidden md:inline">|</span>
                <a href="./privacy-policy.html" target="_blank" class="hover:underline whitespace-nowrap">Privatlivspolitik</a>
                <span class="hidden md:inline">|</span>
                <a href="./terms-of-service.html" target="_blank" class="hover:underline whitespace-nowrap">Brugsbetingelser</a>
                <span class="hidden md:inline">|</span>
                <button id="contact-btn" class="hover:underline whitespace-nowrap">Kontakt os</button>
            </div>
        </footer>
    </div>

    <div id="how-it-works-modal" class="modal-overlay">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg m-4">
            <h2 class="text-2xl font-bold mb-4">Sådan fungerer Den Rette Gave</h2>
            <div class="text-slate-600 space-y-4">
                <p>Vores intelligente quiz bestemmer spørgsmål for spørgsmål præcis hvilke produkter der skal overvejes, og hvilke der skal sorteres fra, indtil vi har indsnævret søgningen til den perfekte gave til anledningen.</p>
                <p><strong>Feedback & Deling:</strong> Når du får et forslag, kan du give det stjerner for at hjælpe os med at forbedre vores logik. Du kan også dele resultatet med en ven via et sikkert, anonymt link.</p>
                <p><strong>Affiliate Links (Sådan tjener vi penge):</strong> Når vi foreslår en gave, er linket et "affiliate link". Hvis du køber produktet, modtager vi en lille kommission. **Dette koster dig intet ekstra!** Det er sådan, vi kan holde Den Rette Gave kørende og gratis at bruge.</p>
            </div>
            <button class="close-modal-btn mt-6 bg-blue-600 text-white font-bold py-2 px-5 rounded-lg w-full hover:bg-blue-700">Forstået!</button>
        </div>
    </div>

    <div id="contact-modal" class="modal-overlay">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md m-4 text-center">
            <h2 class="text-2xl font-bold mb-4">Kontakt Os</h2>
            <p class="text-slate-600">Har du spørgsmål, feedback eller forslag? Vi vil meget gerne høre fra dig!</p>
            <p class="mt-4">Send os en e-mail på:</p>
            <a href="mailto:support@denrettegave.dk" class="text-blue-600 font-bold text-lg hover:underline">support@denrettegave.dk</a>
            <button class="close-modal-btn mt-6 bg-slate-200 text-slate-800 font-bold py-2 px-5 rounded-lg w-full hover:bg-slate-300">Luk</button>
        </div>
    </div>

    <div id="report-problem-modal" class="modal-overlay">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg m-4">
            <h2 class="text-2xl font-bold mb-4">Rapportér et problem</h2>
            <div id="report-options" class="space-y-3">
                <button class="w-full text-left p-3 bg-slate-100 hover:bg-slate-200 rounded-lg" data-report-type="Billedet mangler">Billedet mangler</button>
                <button class="w-full text-left p-3 bg-slate-100 hover:bg-slate-200 rounded-lg" data-report-type="Linket virker ikke">Linket virker ikke</button>
                <button class="w-full text-left p-3 bg-slate-100 hover:bg-slate-200 rounded-lg" data-report-type="Prisen er forkert">Prisen er forkert</button>
                <button class="w-full text-left p-3 bg-slate-100 hover:bg-slate-200 rounded-lg" data-report-type="Andet">Andet</button>
            </div>
            <div id="report-feedback" class="hidden text-center p-4 bg-green-100 text-green-800 rounded-lg mt-4">Tak for din feedback!</div>
            <button class="close-modal-btn mt-6 text-slate-500 font-semibold w-full">Annuller</button>
        </div>
    </div>

    <div id="share-modal" class="modal-overlay">
         <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4">Del denne gaveidé</h2>
            <div class="space-y-3">
                <input type="text" id="share-link-input" readonly class="w-full bg-gray-100 rounded border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 text-base outline-none text-gray-700 py-1 px-3 leading-8 transition-colors duration-200 ease-in-out">
                <button id="copy-share-link-button" class="w-full text-center p-3 bg-slate-200 text-slate-800 rounded-lg font-bold hover:bg-slate-300">Kopiér Link</button>
            </div>
            <p id="share-copy-feedback" class="text-sm text-green-600 mt-2 text-center hidden">Link kopieret!</p>
            <button class="close-modal-btn mt-6 text-slate-500 font-semibold w-full">Luk</button>
        </div>
    </div>
    
    <div id="cookie-banner" class="hidden fixed bottom-0 left-0 right-0 bg-white p-4 shadow-2xl border-t z-50 transform translate-y-full transition-transform duration-500 ease-in-out">
        <div class="max-w-4xl mx-auto md:flex items-center justify-between">
            <p class="text-slate-700 text-sm mb-4 md:mb-0">Denne side bruger cookies for at sikre den bedste oplevelse. Ved at bruge siden accepterer du vores brug af cookies. Læs mere i vores <a href="./privacy-policy.html" target="_blank" class="font-semibold text-blue-600 hover:underline">privatlivspolitik</a>.</p>
            <button id="accept-cookies-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg w-full md:w-auto">Accepter</button>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const views = {
            landing: document.getElementById('landing-view'),
            quiz: document.getElementById('quiz-view'),
            results: document.getElementById('results-view')
        };
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const restartQuizBtn = document.getElementById('restart-quiz-btn');
        const quizContainer = document.getElementById('quiz-container');
        const questionTitle = document.getElementById('question-title');
        const questionText = document.getElementById('question-text');
        const answersContainer = document.getElementById('answers-container');
        const earlyExitBtn = document.getElementById('early-exit-btn');
        const resultsTitle = document.getElementById('results-title');
        const resultsContainer = document.getElementById('results-container');
        
        // Modals & Banners
        const howItWorksModal = document.getElementById('how-it-works-modal');
        const reportProblemModal = document.getElementById('report-problem-modal');
        const shareModal = document.getElementById('share-modal');
        const contactModal = document.getElementById('contact-modal');
        const cookieBanner = document.getElementById('cookie-banner');

        // --- CONFIGURATION ---
        const SCORE_THRESHOLD = 1.8; // Increased threshold to prevent premature results
        const MIN_ANSWERS_FOR_THRESHOLD = 3; // Require at least 3 answers before threshold can trigger a result
        const TOP_N_PRODUCTS_FOR_DIFFERENTIATION = 5;
        const TAG_WEIGHTS = {
            gender: 3.0,
            age: 2.5,
            price: 5.0,
            occasion: 1.5,
            interest: 4.0, // Increased weight for interests
        };

        // --- STATE ---
        let allProducts = [];
        let allQuestions = [];
        let quizState = {};
        let topProductResult = null;
        let currentReportProductId = null;

        // --- INITIALIZATION ---
        const initializeQuizState = () => {
            quizState = {
                answers: {},
                productScores: {},
                askedQuestionIds: new Set(),
                availableProducts: [...allProducts],
            };
        };
        
        const fetchData = async () => {
            try {
                const [productsRes, questionsRes] = await Promise.all([
                    fetch('./assets/products.json'),
                    fetch('./assets/questions.json')
                ]);
                allProducts = await productsRes.json();
                allQuestions = await questionsRes.json();
            } catch (error) {
                console.error("Failed to fetch initial data:", error);
                document.getElementById('app').innerHTML = `<p class="text-center text-red-500 p-8">Kunne ikke indlæse data. Prøv venligst igen senere.</p>`;
            }
        };

        // --- VIEW & MODAL MANAGEMENT ---
        const switchView = (activeView) => {
            Object.values(views).forEach(view => view.classList.remove('active'));
            views[activeView].classList.add('active');
        };

        const handleModal = (modalElement, openTriggers, closeTriggers) => {
            openTriggers.forEach(trigger => trigger.addEventListener('click', () => modalElement.classList.add('visible')));
            closeTriggers.forEach(trigger => trigger.addEventListener('click', () => modalElement.classList.remove('visible')));
            modalElement.addEventListener('click', (e) => {
                if (e.target === modalElement) modalElement.classList.remove('visible');
            });
        };
        
        // --- QUIZ FLOW ---
        const startQuiz = () => {
            initializeQuizState();
            switchView('quiz');
            const initialQuestion = allQuestions.find(q => q.is_initial && q.id === 'q_gender');
            renderQuestion(initialQuestion || allQuestions[0]);
        };

        const handleAnswerSelection = (tag, questionId) => {
            const currentWrapper = quizContainer.querySelector('.question-wrapper');
            if(currentWrapper) currentWrapper.classList.add('exiting');
            
            setTimeout(() => {
                quizState.askedQuestionIds.add(questionId);
                const [key, value] = tag.split(':');
                quizState.answers[key] = value;
                
                updateScores();
                const nextStep = selectNextQuestion();
                
                if (nextStep.type === 'question') {
                    renderQuestion(nextStep.question);
                } else if (nextStep.type === 'result') {
                    showResults(nextStep.product);
                }
            }, 500); // Wait for exit animation
        };

        // --- CORE LOGIC: SCORING & SELECTION ---
        const updateScores = () => {
            const availableProducts = allProducts.filter(product => {
                if (quizState.answers.price && !product.tags.includes(`price:${quizState.answers.price}`)) return false;
                for (const key in quizState.answers) {
                     const isDifferentiator = allQuestions.some(q => q.answers.some(a => a.tag.startsWith(key)) && q.is_differentiator);
                     if (isDifferentiator && !product.differentiator_tags.includes(`${key}:${quizState.answers[key]}`)) return false;
                }
                return product.status === 'active';
            });
            quizState.availableProducts = availableProducts;

            const scores = {};
            availableProducts.forEach(product => {
                let score = 0;
                product.tags.forEach(tag => {
                    const [key, value] = tag.split(':');
                    const weight = TAG_WEIGHTS[key] || 1.0;
                    if (quizState.answers[key] === value) score += weight;
                    else if (key === 'gender' && value === 'alle' && quizState.answers.gender) score += weight / 2;
                });
                scores[product.id] = score;
            });
            quizState.productScores = scores;
        };

        const selectNextQuestion = () => {
            const sortedProducts = Object.entries(quizState.productScores).sort((a, b) => b[1] - a[1]);

            if (sortedProducts.length === 0) {
                 return { type: 'result', product: null };
            }
            
            const topScore = sortedProducts[0][1];
            const secondScore = sortedProducts.length > 1 ? sortedProducts[1][1] : 0;
            const bestProduct = allProducts.find(p => p.id === sortedProducts[0][0]);

            if (Object.keys(quizState.answers).length >= MIN_ANSWERS_FOR_THRESHOLD && topScore > 0 && (topScore / (secondScore + 0.1)) > SCORE_THRESHOLD) {
                return { type: 'result', product: bestProduct };
            }
            
            // Find next initial question if any are left
            const nextInitial = allQuestions.find(q => q.is_initial && !quizState.askedQuestionIds.has(q.id));
            if(nextInitial) return { type: 'question', question: nextInitial };

            const topProductIds = sortedProducts.slice(0, TOP_N_PRODUCTS_FOR_DIFFERENTIATION).map(p => p[0]);
            const topProducts = allProducts.filter(p => topProductIds.includes(p.id));

            let nextQuestion = findDifferentiatorQuestion(topProducts, quizState.askedQuestionIds);
            if (!nextQuestion) {
                nextQuestion = findDiscoveryQuestion(quizState.askedQuestionIds);
            }

            if (nextQuestion) {
                return { type: 'question', question: nextQuestion };
            }

            return { type: 'result', product: bestProduct };
        };

        const findDifferentiatorQuestion = (topProducts, askedIds) => {
            let bestQuestion = null;
            let maxDifferentiation = -1;
            const potentialQuestions = allQuestions.filter(q => !askedIds.has(q.id) && !q.is_initial);

            potentialQuestions.forEach(question => {
                const tagsInQuestion = new Set(question.answers.map(a => a.tag));
                const productTagSets = topProducts.map(p => new Set([...p.tags, ...(p.differentiator_tags || [])]));
                let splits = 0;
                for (const tag of tagsInQuestion) {
                    const productsWithTag = productTagSets.filter(pt => pt.has(tag)).length;
                    if (productsWithTag > 0 && productsWithTag < topProducts.length) splits++;
                }
                if (splits > maxDifferentiation) {
                    maxDifferentiation = splits;
                    bestQuestion = question;
                }
            });
            return bestQuestion;
        };

        const findDiscoveryQuestion = (askedIds) => {
             return allQuestions.find(q => !q.is_initial && !q.is_differentiator && !askedIds.has(q.id));
        };

        // --- UI RENDERING ---
        const renderQuestion = (question) => {
            if (Object.keys(quizState.answers).length >= 2) earlyExitBtn.classList.remove('hidden');

            let optionsHtml = '';
            if (question.answers) {
                 optionsHtml = `<div class="grid grid-cols-2 md:grid-cols-3 gap-4">` + question.answers.map(o => `<div class="quiz-card bg-white p-4 rounded-lg shadow cursor-pointer" data-tag="${o.tag}" data-question-id="${question.id}"><span class="font-semibold pointer-events-none">${o.text}</span></div>`).join('') + `</div>`;
            }
            quizContainer.innerHTML = `<div class="question-wrapper active"><h3 class="text-2xl md:text-3xl font-bold text-center mb-8">${question.question_text}</h3>${optionsHtml}</div>`;
        };

        const showResults = (product, sharedAnswers) => {
            topProductResult = product;
            if (sharedAnswers) quizState.answers = sharedAnswers;

            resultsTitle.textContent = 'Her er vores forslag!';
            resultsContainer.innerHTML = product ? createProductCard(product) : `<p class="text-center">Vi kunne desværre ikke finde et match.</p>`;
            switchView('results');
        };

        const createProductCard = (product) => {
            return `<div class="bg-white rounded-lg shadow-xl max-w-md mx-auto text-left overflow-hidden">
                    <img src="${product.image}" alt="${product.name}" class="w-full h-64 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e2e8f0/475569?text=Billede+mangler';">
                    <div class="p-6">
                        <h3 class="text-2xl font-bold mb-2">${product.name}</h3>
                        <p class="text-slate-600 mb-4">${product.description}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-3xl font-bold text-slate-800">${product.price} kr.</span>
                            <a href="${product.url}" target="_blank" class="affiliate-link bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700" data-product-id="${product.id}">Se produkt</a>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-4 border-t">
                        <div class="mb-4"><p class="text-sm font-semibold text-center mb-2">Hvor godt ramte vi plet?</p><div class="star-rating flex justify-center text-3xl" data-product-id="${product.id}">${[1,2,3,4,5].map(i => `<button data-value="${i}">★</button>`).join('')}</div></div>
                        <div class="text-center"><button class="share-btn text-blue-600 font-semibold hover:underline">Del dit resultat</button></div>
                        <div class="text-xs text-slate-400 mt-4 text-right"><button class="report-btn hover:underline" data-product-id="${product.id}">Rapportér et problem</button></div>
                    </div>
                </div>`;
        };
        
        // --- EVENT LISTENERS & API CALLS ---
        const setupEventListeners = () => {
            startQuizBtn.addEventListener('click', startQuiz);
            restartQuizBtn.addEventListener('click', () => { window.location.href = window.location.pathname; });
            earlyExitBtn.addEventListener('click', () => showResults(Object.values(quizState.productScores).length > 0 ? allProducts.find(p => p.id === Object.entries(quizState.productScores).sort((a,b) => b[1] - a[1])[0][0]) : null));
            
            quizContainer.addEventListener('click', e => {
                const target = e.target.closest('[data-tag]');
                if (target) handleAnswerSelection(target.dataset.tag, target.dataset.questionId);
            });
            
            resultsContainer.addEventListener('click', async e => {
                if (e.target.closest('.report-btn')) {
                    currentReportProductId = e.target.closest('.report-btn').dataset.productId;
                    document.getElementById('report-options').classList.remove('hidden');
                    document.getElementById('report-feedback').classList.add('hidden');
                    reportProblemModal.classList.add('visible');
                }
                 if (e.target.closest('.share-btn')) {
                     createShareLink(topProductResult.id, quizState.answers);
                 }
                 if (e.target.closest('.star-rating button')) {
                    const button = e.target.closest('.star-rating button');
                    const rating = parseInt(button.dataset.value, 10);
                    const productId = button.parentElement.dataset.productId;
                    submitRating(productId, rating);
                    const stars = button.parentElement.querySelectorAll('button');
                    stars.forEach(star => {
                        star.classList.toggle('selected', star.dataset.value <= rating);
                        star.disabled = true;
                    });
                }
            });

             reportProblemModal.querySelector('#report-options').addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON') {
                    submitFlag(currentReportProductId, e.target.dataset.reportType);
                    document.getElementById('report-options').classList.add('hidden');
                    document.getElementById('report-feedback').classList.remove('hidden');
                    setTimeout(() => reportProblemModal.classList.remove('visible'), 1500);
                }
            });
            
            document.getElementById('copy-share-link-button').onclick = () => {
                const link = document.getElementById('share-link-input').value;
                navigator.clipboard.writeText(link).then(() => {
                    const feedback = document.getElementById('share-copy-feedback');
                    feedback.classList.remove('hidden');
                    setTimeout(() => feedback.classList.add('hidden'), 2000);
                });
            };

            // Cookie Banner
            const acceptCookiesBtn = document.getElementById('accept-cookies-btn');
            if (!localStorage.getItem('cookieConsent')) {
                cookieBanner.classList.remove('hidden');
                setTimeout(() => cookieBanner.classList.remove('translate-y-full'), 100);
            }
            acceptCookiesBtn.addEventListener('click', () => {
                localStorage.setItem('cookieConsent', 'true');
                cookieBanner.classList.add('translate-y-full');
                setTimeout(() => cookieBanner.classList.add('hidden'), 500);
            });

            // Modals
            handleModal(howItWorksModal, [document.getElementById('how-it-works-btn')], document.querySelectorAll('#how-it-works-modal .close-modal-btn'));
            handleModal(contactModal, [document.getElementById('contact-btn')], document.querySelectorAll('#contact-modal .close-modal-btn'));
            handleModal(reportProblemModal, [], document.querySelectorAll('#report-problem-modal .close-modal-btn'));
            handleModal(shareModal, [], document.querySelectorAll('#share-modal .close-modal-btn'));
        };

        const submitRating = async (productId, rating) => {
            try {
                await fetch('/api/submit-rating', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId, rating })
                });
            } catch (error) { console.error('Failed to submit rating:', error); }
        };

        const submitFlag = async (productId, reason) => {
            try {
                await fetch('/api/submit-flag', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId, reason, quizAnswers: quizState.answers })
                });
            } catch (error) { console.error('Failed to submit flag:', error); }
        };

        const createShareLink = async (productId, answers) => {
            try {
                const response = await fetch('/api/create-share-link', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_id: productId, quiz_answers: answers })
                });
                const { shareId } = await response.json();
                const link = `${window.location.origin}${window.location.pathname}?share=${shareId}`;
                document.getElementById('share-link-input').value = link;
                shareModal.classList.add('visible');
            } catch (error) { console.error('Failed to create share link:', error); }
        };

        const loadSharedResult = async (shareId) => {
            try {
                const response = await fetch(`/api/get-shared-result?id=${shareId}`);
                if (!response.ok) throw new Error('Share link not found');
                const { product_id, quiz_answers } = await response.json();
                const product = allProducts.find(p => p.id === product_id);
                if(product) {
                    showResults(product, quiz_answers);
                } else { throw new Error('Product from share link not found'); }
            } catch (error) {
                console.error("Failed to load shared link:", error);
                document.getElementById('app').innerHTML = `<p class="text-red-500 text-center">Dette delingslink er ugyldigt eller udløbet.</p>`;
            }
        };
        
        // --- APP START ---
        const startApp = async () => {
            await fetchData();
            if (allProducts.length > 0 && allQuestions.length > 0) {
                const urlParams = new URLSearchParams(window.location.search);
                const shareId = urlParams.get('share');
                if (shareId) {
                    loadSharedResult(shareId);
                }
                setupEventListeners();
            }
        };

        document.addEventListener('DOMContentLoaded', startApp);
    </script>
</body>
</html>
