<!DOCTYPE html>
<html lang="da" class="h-full bg-gray-50">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GaveGuiden - Find den perfekte gave</title>
    <link href="https://rsms.me/inter/inter.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
    </style>
</head>

<body class="h-full">
    <div class="flex min-h-full items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="w-full max-w-md space-y-8">

            <div id="landing-view">
                <div>
                    <img class="mx-auto h-12 w-auto" src="https://tailwindui.com/img/logos/mark.svg?color=indigo&shade=600" alt="GaveGuiden">
                    <h2 class="mt-6 text-center text-3xl font-bold tracking-tight text-gray-900">Find den perfekte gave på sekunder</h2>
                    <p class="mt-2 text-center text-sm text-gray-600">
                        Besvar et par hurtige spørgsmål, og lad vores smarte guide finde den ideelle gave til enhver anledning.
                    </p>
                </div>
                <div class="mt-8">
                    <button id="start-quiz-button" type="button" class="group relative flex w-full justify-center rounded-md border border-transparent bg-indigo-600 py-3 px-4 text-lg font-semibold text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        Start Guiden
                    </button>
                </div>
            </div>

            <div id="quiz-view" class="hidden">
                <div class="px-4 sm:px-0">
                    <h3 id="question-title" class="text-2xl font-semibold leading-7 text-gray-900 text-center">Spørgsmål</h3>
                    <p id="question-text" class="mt-1 max-w-2xl text-md leading-6 text-gray-500 text-center">...</p>
                </div>
                <div class="mt-6 border-t border-gray-100">
                    <div id="answers-container" class="divide-y divide-gray-100">
                        </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-8">
                    <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <div id="result-view" class="hidden text-center">
                <h2 class="text-2xl font-bold tracking-tight text-gray-900">Vi har fundet den perfekte gave!</h2>
                <div id="result-card" class="mt-6">
                    </div>
                <div class="mt-6 flex items-center justify-center gap-x-6">
                    <button id="restart-quiz-button" type="button" class="rounded-md bg-indigo-600 px-3.5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">Start forfra</button>
                    <button id="report-problem-button" type="button" class="text-sm font-semibold leading-6 text-gray-900">Rapporter et problem <span aria-hidden="true">→</span></button>
                </div>
            </div>

             <div id="report-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3 text-center">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Rapporter et problem</h3>
                        <div class="mt-2 px-7 py-3">
                            <p class="text-sm text-gray-500">Hvad var problemet med forslaget?</p>
                            <select id="report-reason" class="mt-2 block w-full rounded-md border-0 py-1.5 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                <option>Gaven passer ikke til personen</option>
                                <option>Linket til produktet er i stykker</option>
                                <option>Prisen er forkert</option>
                                <option>Andet</option>
                            </select>
                        </div>
                        <div class="items-center px-4 py-3">
                            <button id="submit-report-button" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">Send Rapport</button>
                            <button id="cancel-report-button" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">Annuller</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="share-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
                 <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3 text-center">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Del dette gaveforslag</h3>
                        <div class="mt-2 px-7 py-3">
                            <input type="text" id="share-link-input" readonly class="w-full bg-gray-100 rounded border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 text-base outline-none text-gray-700 py-1 px-3 leading-8 transition-colors duration-200 ease-in-out">
                        </div>
                        <div class="items-center px-4 py-3">
                            <button id="copy-share-link-button" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">Kopier Link</button>
                            <button id="close-share-modal-button" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">Luk</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const landingView = document.getElementById('landing-view');
        const quizView = document.getElementById('quiz-view');
        const resultView = document.getElementById('result-view');
        const startQuizButton = document.getElementById('start-quiz-button');
        const restartQuizButton = document.getElementById('restart-quiz-button');
        const questionTitle = document.getElementById('question-title');
        const questionText = document.getElementById('question-text');
        const answersContainer = document.getElementById('answers-container');
        const progressBar = document.getElementById('progress-bar');
        const resultCard = document.getElementById('result-card');

        // Modals
        const reportModal = document.getElementById('report-modal');
        const shareModal = document.getElementById('share-modal');
        const reportProblemButton = document.getElementById('report-problem-button');
        const cancelReportButton = document.getElementById('cancel-report-button');
        const submitReportButton = document.getElementById('submit-report-button');
        const closeShareModalButton = document.getElementById('close-share-modal-button');
        const copyShareLinkButton = document.getElementById('copy-share-link-button');
        const shareLinkInput = document.getElementById('share-link-input');
        

        // --- CONFIGURATION ---
        const SCORE_THRESHOLD = 1.5;
        const TOP_N_PRODUCTS_FOR_DIFFERENTIATION = 5;
        const TAG_WEIGHTS = {
            gender: 3.0,
            age: 2.5,
            price: 5.0, // Budget is very important
            occasion: 1.5,
            interest: 2.0,
        };

        // --- STATE ---
        let allProducts = [];
        let allQuestions = [];
        let quizState = {};
        let totalDiscoverableQuestions = 0;

        // --- INITIALIZATION ---
        const initializeQuizState = () => {
            quizState = {
                answers: {}, // e.g., { gender: 'mand', price: 'billig' }
                productScores: {}, // e.g., { 'prod1': 5.0, 'prod2': 3.5 }
                askedQuestionIds: new Set(),
                availableProducts: [...allProducts],
                answeredDiscoveryQuestions: 0
            };
        };

        const fetchData = async () => {
            try {
                const [productsRes, questionsRes] = await Promise.all([
                    fetch('/assets/products.json'),
                    fetch('/assets/questions.json')
                ]);
                allProducts = await productsRes.json();
                allQuestions = await questionsRes.json();
                totalDiscoverableQuestions = allQuestions.filter(q => !q.is_initial && !q.is_differentiator).length;
            } catch (error) {
                console.error("Failed to fetch initial data:", error);
                // Display an error message to the user
                landingView.innerHTML = '<p class="text-red-500 text-center">Kunne ikke indlæse data. Prøv venligst igen senere.</p>';
            }
        };

        const startApp = async () => {
            await fetchData();
            if(allProducts.length > 0 && allQuestions.length > 0) {
                 // Check for shared link
                const urlParams = new URLSearchParams(window.location.search);
                const shareId = urlParams.get('share');
                if (shareId) {
                    loadSharedResult(shareId);
                } else {
                    setupLandingListeners();
                }
            }
        };

        const setupLandingListeners = () => {
            startQuizButton.addEventListener('click', startQuiz);
            restartQuizButton.addEventListener('click', () => {
                 window.location.search = ''; // Clear URL params
                 startQuiz();
            });
        }

        // --- QUIZ FLOW ---
        const startQuiz = () => {
            initializeQuizState();
            landingView.classList.add('hidden');
            resultView.classList.add('hidden');
            quizView.classList.remove('hidden');

            const initialQuestion = allQuestions.find(q => q.is_initial);
            if (initialQuestion) {
                renderQuestion(initialQuestion);
            } else {
                console.error("No initial question found!");
            }
        };

        const handleAnswerSelection = (tag, questionId) => {
            const question = allQuestions.find(q => q.id === questionId);
            if (question && !question.is_initial && !question.is_differentiator) {
                quizState.answeredDiscoveryQuestions++;
            }

            quizState.askedQuestionIds.add(questionId);

            const [key, value] = tag.split(':');
            quizState.answers[key] = value;
            
            updateScores();

            const nextStep = selectNextQuestion();

            if (nextStep.type === 'question') {
                renderQuestion(nextStep.question);
            } else if (nextStep.type === 'result') {
                renderResults(nextStep.product);
            }
        };

        // --- CORE LOGIC: SCORING & SELECTION ---

        const updateScores = () => {
            // Filter products first based on hard constraints like price
            let availableProducts = allProducts.filter(product => {
                if (quizState.answers.price) {
                    const priceTag = `price:${quizState.answers.price}`;
                    if (!product.tags.includes(priceTag)) return false;
                }
                for (const key in quizState.answers) {
                    const answerTag = `${key}:${quizState.answers[key]}`;
                    const isDifferentiator = allQuestions.some(q => q.id.includes(key) && q.is_differentiator);
                     if (isDifferentiator && !product.differentiator_tags.includes(answerTag)) return false;
                }
                return true;
            });
            quizState.availableProducts = availableProducts;

            const scores = {};
            availableProducts.forEach(product => {
                let score = 0;
                product.tags.forEach(tag => {
                    const [key, value] = tag.split(':');
                    const weight = TAG_WEIGHTS[key] || 1.0;
                    
                    if (quizState.answers[key] === value) {
                        score += weight;
                    }
                    else if (key === 'gender' && value === 'alle' && quizState.answers.gender) {
                        score += weight / 2;
                    }
                });
                scores[product.id] = score;
            });
            quizState.productScores = scores;
        };
        
        const selectNextQuestion = () => {
            const sortedProducts = Object.entries(quizState.productScores)
                .sort((a, b) => b[1] - a[1]);

            if (sortedProducts.length === 0) {
                 const lastAnswerKey = Object.keys(quizState.answers).pop();
                 delete quizState.answers[lastAnswerKey];
                 updateScores();
                 const lastChanceSorted = Object.entries(quizState.productScores).sort((a,b) => b[1] - a[1]);
                 if(lastChanceSorted.length > 0) {
                    const bestProduct = allProducts.find(p => p.id === lastChanceSorted[0][0]);
                    return { type: 'result', product: bestProduct };
                 }
                 return { type: 'result', product: null };
            }
            
            const topScore = sortedProducts[0][1];
            const secondScore = sortedProducts.length > 1 ? sortedProducts[1][1] : 0;
            const bestProduct = allProducts.find(p => p.id === sortedProducts[0][0]);

            if (topScore > 0 && (topScore / (secondScore + 0.1)) > SCORE_THRESHOLD) {
                return { type: 'result', product: bestProduct };
            }

            const topProductIds = sortedProducts.slice(0, TOP_N_PRODUCTS_FOR_DIFFERENTIATION).map(p => p[0]);
            const topProducts = allProducts.filter(p => topProductIds.includes(p.id));

            let nextQuestion = findDifferentiatorQuestion(topProducts, quizState.askedQuestionIds);
            if (!nextQuestion) {
                nextQuestion = findDiscoveryQuestion(quizState.askedQuestionIds);
            }

            if (nextQuestion) {
                return { type: 'question', question: nextQuestion };
            }

            return { type: 'result', product: bestProduct };
        };

        const findDifferentiatorQuestion = (topProducts, askedIds) => {
            let bestQuestion = null;
            let maxDifferentiation = -1;

            const potentialQuestions = allQuestions.filter(q => !askedIds.has(q.id) && q.is_differentiator);

            potentialQuestions.forEach(question => {
                const tagsInQuestion = new Set(question.answers.map(a => a.tag));
                const productTagSets = topProducts.map(p => new Set([...p.tags, ...(p.differentiator_tags || [])]));
                
                let splits = 0;
                for (const tag of tagsInQuestion) {
                    const productsWithTag = productTagSets.filter(pt => pt.has(tag)).length;
                    if (productsWithTag > 0 && productsWithTag < topProducts.length) {
                        splits++;
                    }
                }

                if (splits > maxDifferentiation) {
                    maxDifferentiation = splits;
                    bestQuestion = question;
                }
            });

            return bestQuestion;
        };

        const findDiscoveryQuestion = (askedIds) => {
             return allQuestions.find(q => !q.is_initial && !q.is_differentiator && !askedIds.has(q.id));
        };

        // --- UI RENDERING ---

        const renderQuestion = (question) => {
            questionTitle.textContent = `Spørgsmål ${quizState.askedQuestionIds.size + 1}`;
            questionText.textContent = question.question_text;
            answersContainer.innerHTML = '';
            
            question.answers.forEach(answer => {
                const answerDiv = document.createElement('div');
                answerDiv.className = "px-4 py-4 sm:px-0";
                
                const button = document.createElement('button');
                button.type = 'button';
                button.className = "group relative flex w-full justify-center rounded-md border border-gray-300 bg-white py-3 px-4 text-md font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2";
                button.textContent = answer.text;
                button.onclick = () => handleAnswerSelection(answer.tag, question.id);

                answerDiv.appendChild(button);
                answersContainer.appendChild(answerDiv);
            });

            const progress = totalDiscoverableQuestions > 0 ? (quizState.answeredDiscoveryQuestions / totalDiscoverableQuestions) * 100 : 0;
            progressBar.style.width = `${Math.min(progress, 100)}%`;
        };
        
        const renderResults = (product) => {
            quizView.classList.add('hidden');
            resultView.classList.remove('hidden');
            resultCard.innerHTML = ''; // Clear previous results

            if (!product) {
                const messageHeader = document.createElement('h3');
                messageHeader.className = 'text-xl font-semibold text-gray-800';
                messageHeader.textContent = 'Beklager!';
                
                const messageText = document.createElement('p');
                messageText.className = 'mt-2 text-gray-600';
                messageText.textContent = 'Vi kunne ikke finde en gave, der passede præcist til dine kriterier. Prøv venligst igen med lidt andre svar.';
                
                resultCard.appendChild(messageHeader);
                resultCard.appendChild(messageText);

                reportProblemButton.classList.add('hidden');
                return;
            }
            reportProblemButton.classList.remove('hidden');

            const container = document.createElement('div');
            container.className = 'bg-white rounded-lg shadow-lg overflow-hidden';

            const img = document.createElement('img');
            img.className = 'w-full h-56 object-cover object-center';
            img.src = product.image;
            img.alt = product.name;
            container.appendChild(img);

            const contentDiv = document.createElement('div');
            contentDiv.className = 'p-6';
            
            const nameH3 = document.createElement('h3');
            nameH3.className = 'text-xl font-semibold text-gray-800';
            nameH3.textContent = product.name;
            contentDiv.appendChild(nameH3);
            
            const descriptionP = document.createElement('p');
            descriptionP.className = 'mt-2 text-gray-600';
            descriptionP.textContent = product.description;
            contentDiv.appendChild(descriptionP);

            const priceP = document.createElement('p');
            priceP.className = 'mt-4 text-3xl font-bold text-gray-900';
            priceP.textContent = `${product.price} kr.`;
            contentDiv.appendChild(priceP);

            const linkA = document.createElement('a');
            linkA.href = product.url;
            linkA.target = '_blank';
            linkA.className = 'mt-6 block w-full text-center rounded-md bg-indigo-600 px-3.5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500';
            linkA.textContent = 'Se gaven her';
            contentDiv.appendChild(linkA);

            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'mt-4 flex justify-around';

            const shareButton = document.createElement('button');
            shareButton.id = 'share-button';
            shareButton.className = 'text-indigo-600 hover:text-indigo-800 font-medium';
            shareButton.textContent = 'Del forslag';
            buttonsDiv.appendChild(shareButton);

            const ratingDiv = document.createElement('div');
            ratingDiv.className = 'flex items-center';

            const ratingSpan = document.createElement('span');
            ratingSpan.className = 'text-gray-600 mr-2';
            ratingSpan.textContent = 'Bedøm forslag:';
            ratingDiv.appendChild(ratingSpan);

            for(let i = 1; i <= 5; i++) {
                const starSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                starSvg.setAttribute('data-rating', i);
                starSvg.setAttribute('class', 'w-6 h-6 text-gray-300 cursor-pointer star-rating');
                starSvg.setAttribute('fill', 'currentColor');
                starSvg.setAttribute('viewBox', '0 0 20 20');
                const starPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                starPath.setAttribute('d', 'M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z');
                starSvg.appendChild(starPath);
                ratingDiv.appendChild(starSvg);
            }

            buttonsDiv.appendChild(ratingDiv);
            contentDiv.appendChild(buttonsDiv);
            container.appendChild(contentDiv);
            resultCard.appendChild(container);

            setupResultCardListeners(product);
        };
        
        // --- EVENT LISTENERS & MODALS ---
        
        const setupResultCardListeners = (product) => {
            document.querySelectorAll('.star-rating').forEach(star => {
                star.addEventListener('click', () => {
                    const rating = star.dataset.rating;
                    submitRating(product.id, parseInt(rating));
                    document.querySelectorAll('.star-rating').forEach(s => {
                        s.classList.toggle('text-yellow-400', s.dataset.rating <= rating);
                        s.classList.toggle('text-gray-300', s.dataset.rating > rating);
                    });
                });
            });

            reportProblemButton.onclick = () => {
                reportModal.classList.remove('hidden');
                submitReportButton.dataset.productId = product.id;
            };

            document.getElementById('share-button').onclick = () => {
                createShareLink(product.id, quizState.answers);
            };
        };

        cancelReportButton.onclick = () => reportModal.classList.add('hidden');
        closeShareModalButton.onclick = () => shareModal.classList.add('hidden');

        submitReportButton.onclick = async () => {
            const productId = submitReportButton.dataset.productId;
            const reason = document.getElementById('report-reason').value;
            
            try {
                await fetch('/api/submit-flag', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId, reason, quizAnswers: quizState.answers }),
                });
                alert('Tak for din feedback!');
            } catch (error) {
                console.error('Failed to submit report:', error);
                alert('Der skete en fejl. Prøv igen.');
            } finally {
                reportModal.classList.add('hidden');
            }
        };

        const submitRating = async (productId, rating) => {
             try {
                await fetch('/api/submit-rating', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId, rating }),
                });
            } catch (error) {
                console.error('Failed to submit rating:', error);
            }
        };

        const createShareLink = async (productId, answers) => {
            try {
                const response = await fetch('/api/create-share-link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_id: productId, quiz_answers: answers }),
                });
                const { shareId } = await response.json();
                const link = `${window.location.origin}${window.location.pathname}?share=${shareId}`;
                shareLinkInput.value = link;
                shareModal.classList.remove('hidden');
            } catch (error) {
                 console.error('Failed to create share link:', error);
                 alert('Kunne ikke oprette delingslink.');
            }
        };

        copyShareLinkButton.onclick = () => {
            const link = shareLinkInput.value;
            navigator.clipboard.writeText(link).then(() => {
                copyShareLinkButton.textContent = 'Kopieret!';
                setTimeout(() => { copyShareLinkButton.textContent = 'Kopier Link'; }, 2000);
            }, (err) => {
                console.error('Could not copy text: ', err);
                alert('Fejl: Kunne ikke kopiere link.');
            });
        };

        const loadSharedResult = async (shareId) => {
            try {
                const response = await fetch(`/api/get-shared-result?id=${shareId}`);
                if (!response.ok) throw new Error('Share link not found');
                const { product_id, quiz_answers } = await response.json();
                const product = allProducts.find(p => p.id === product_id);
                
                if(product) {
                    quizState.answers = quiz_answers; // Load the state for reporting
                    landingView.classList.add('hidden');
                    quizView.classList.add('hidden');
                    renderResults(product);
                } else {
                     throw new Error('Product from share link not found');
                }
            } catch (error) {
                console.error("Failed to load shared link:", error);
                landingView.innerHTML = '<p class="text-red-500 text-center">Dette delingslink er ugyldigt eller udløbet.</p>';
            } finally {
                 setupLandingListeners();
            }
        };


        // --- LET'S GO ---
        document.addEventListener('DOMContentLoaded', startApp);
    </script>
</body>

</html>
