<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Den Rette Gave - Find den perfekte gave</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .view { display: none; animation: fadeIn 0.6s ease-in-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .question-wrapper { display: none; animation: slideIn 0.5s forwards; }
        .question-wrapper.active { display: block; }
        .question-wrapper.exiting { animation: slideOut 0.5s forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(-50px); } }
        .quiz-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .quiz-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .interest-tag { transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
        .interest-tag.selected { background-color: #4F46E5; color: white; border-color: #4F46E5; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .star-rating button { color: #d1d5db; transition: color 0.2s; }
        .star-rating button.selected, .star-rating:hover button { color: #f59e0b; }
        .star-rating:hover button:hover ~ button { color: #d1d5db; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-2xl md:text-3xl font-bold text-slate-700">Den Rette Gave</h1>
            <nav>
                <button id="how-it-works-btn" class="text-slate-600 hover:text-slate-900 font-semibold">Sådan fungerer det</button>
            </nav>
        </header>

        <main id="landing-view" class="view active text-center">
            <div class="py-12 md:py-24">
                <h2 class="text-4xl md:text-6xl font-bold mb-4">Find den perfekte gave. Hver gang.</h2>
                <p class="text-lg md:text-xl text-slate-600 max-w-2xl mx-auto mb-8">Vores smarte quiz stiller et par simple spørgsmål for at finde personlige gaveidéer til hvem som helst.</p>
                <button id="start-quiz-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-lg hover:bg-blue-700 transition-colors shadow-lg hover:shadow-xl">Start Guiden</button>
            </div>
        </main>

        <main id="quiz-view" class="view">
            <div id="quiz-container" class="relative pt-8"></div>
            <div class="mt-8 text-center">
                <button id="next-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors hidden">Næste</button>
                <button id="early-exit-btn" class="mt-4 text-slate-500 hover:text-slate-800 text-sm hidden">Vis mig resultater nu</button>
            </div>
        </main>

        <main id="results-view" class="view text-center">
             <div class="py-12">
                <h2 id="results-title" class="text-3xl md:text-4xl font-bold mb-4">Vi fandt den perfekte gave!</h2>
                <div id="results-container" class="space-y-8"></div>
                <button id="restart-quiz-btn" class="mt-8 bg-slate-600 text-white font-bold py-3 px-8 rounded-lg text-lg hover:bg-slate-700 transition-colors">Start forfra</button>
            </div>
        </main>

        <footer class="text-center text-slate-500 mt-16 py-4 border-t border-slate-200">
            &copy; 2025 Den Rette Gave
        </footer>
    </div>

    <!-- How It Works Modal -->
    <div id="how-it-works-modal" class="modal-overlay">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg m-4 animate-fadeIn">
            <h2 class="text-2xl font-bold mb-4">Sådan fungerer Den Rette Gave</h2>
            <div class="text-slate-600 space-y-4">
                <p>Velkommen til Den Rette Gave! Vores mål er at gøre gavejagten nem og sjov.</p>
                <p>Vores intelligente quiz bestemmer spørgsmål for spørgsmål præcis hvilke produkter der skal overvejes, og hvilke der skal sorteres fra, indtil vi har indsnævret søgningen til den perfekte gave til anledningen.</p>
                <p><strong>Affiliate Links (Sådan tjener vi penge):</strong> Når vi foreslår en gave, er linket til produktet et "affiliate link". Det betyder, at hvis du klikker på linket og køber produktet, modtager vi en lille kommission fra forhandleren. **Dette koster dig absolut intet ekstra!** Det er sådan, vi kan holde Den Rette Gave kørende og gratis at bruge.</p>
            </div>
            <button class="close-modal-btn mt-6 bg-blue-600 text-white font-bold py-2 px-5 rounded-lg w-full hover:bg-blue-700">Forstået!</button>
        </div>
    </div>

    <!-- Report Problem Modal -->
    <div id="report-problem-modal" class="modal-overlay">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg m-4 animate-fadeIn">
            <h2 class="text-2xl font-bold mb-4">Rapportér et problem</h2>
            <p class="text-slate-600 mb-6">Hvad ser ud til at være galt med dette produktforslag? Din feedback hjælper os med at holde vores guide opdateret.</p>
            <div id="report-options" class="space-y-3">
                <button class="w-full text-left p-3 bg-slate-100 hover:bg-slate-200 rounded-lg" data-report-type="Billedet mangler">Billedet mangler</button>
                <button class="w-full text-left p-3 bg-slate-100 hover:bg-slate-200 rounded-lg" data-report-type="Linket virker ikke">Linket virker ikke</button>
                <button class="w-full text-left p-3 bg-slate-100 hover:bg-slate-200 rounded-lg" data-report-type="Prisen er forkert">Prisen er forkert</button>
                <button class="w-full text-left p-3 bg-slate-100 hover:bg-slate-200 rounded-lg" data-report-type="Andet">Andet</button>
            </div>
            <div id="report-feedback" class="hidden text-center p-4 bg-green-100 text-green-800 rounded-lg mt-4">Tak for din feedback!</div>
            <button class="close-modal-btn mt-6 text-slate-500 font-semibold w-full">Annuller</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const views = { landing: document.getElementById('landing-view'), quiz: document.getElementById('quiz-view'), results: document.getElementById('results-view') };
            const startQuizBtn = document.getElementById('start-quiz-btn');
            const restartQuizBtn = document.getElementById('restart-quiz-btn');
            const quizContainer = document.getElementById('quiz-container');
            const nextBtn = document.getElementById('next-btn');
            const earlyExitBtn = document.getElementById('early-exit-btn');
            const resultsTitle = document.getElementById('results-title');
            const resultsContainer = document.getElementById('results-container');
            
            const howItWorksModal = document.getElementById('how-it-works-modal');
            const reportProblemModal = document.getElementById('report-problem-modal');
            const reportOptions = document.getElementById('report-options');
            const reportFeedback = document.getElementById('report-feedback');

            let products = [];
            try {
                const response = await fetch('./assets/products.json');
                if (!response.ok) throw new Error('Network response was not ok');
                products = await response.json();
            } catch (error) {
                console.error("Failed to load products:", error);
                document.getElementById('app').innerHTML = `<p class="text-center text-red-500 p-8">Kunne ikke indlæse produkter. Sørg for at 'assets/products.json' findes og er korrekt formateret.</p>`;
                return;
            }

            const quizQuestions = [
                { question: "Hvad hedder den heldige?", type: 'text-input', key: 'name', placeholder: 'F.eks. "Mor" eller "Anders"' },
                { question: "Hvem er gaven til?", type: 'single-choice-card', key: 'relation', options: ['Partner', 'Forælder', 'Ven', 'Søskende', 'Kollega', 'Andet'] },
                { question: "Hvad er modtagerens køn?", type: 'single-choice-card', key: 'gender', options: ['Mand', 'Kvinde', 'Andet'] },
                { question: "Hvad er deres cirka alder?", type: 'single-choice-card', key: 'age', options: ['Under 18', '18-25', '26-40', '41-60', '60+'] },
                { question: "Hvad er anledningen?", type: 'single-choice-card', key: 'occasion', options: ['Fødselsdag', 'Jul', 'Årsdag', 'Bare fordi'] },
                { question: "Hvad interesserer de sig for? (Vælg op til 3)", type: 'multi-select-tag', key: 'interests', options: ['Kaffe', 'Hjemmet', 'Bøger', 'Læsning', 'Teknologi', 'Madlavning', 'Mode'] }
            ];

            let currentQuestionIndex = 0;
            let userAnswers = {};
            let currentReportProductId = null;

            const switchView = (activeView) => {
                Object.values(views).forEach(view => view.classList.remove('active'));
                views[activeView].classList.add('active');
            };

            const startQuiz = () => {
                currentQuestionIndex = 0;
                userAnswers = {};
                switchView('quiz');
                renderQuestion();
            };

            const renderQuestion = () => {
                if (currentQuestionIndex >= 2) earlyExitBtn.classList.remove('hidden');
                
                const questionData = quizQuestions[currentQuestionIndex];
                let optionsHtml = '';
                nextBtn.classList.add('hidden');

                if (questionData.type === 'text-input') {
                    optionsHtml = `<div class="flex justify-center"><input type="text" id="text-input-field" class="w-full max-w-md p-3 border-2 border-slate-300 rounded-lg text-center text-lg" placeholder="${questionData.placeholder}"></div>`;
                    nextBtn.classList.remove('hidden');
                } else if (questionData.type === 'single-choice-card') {
                    optionsHtml = `<div class="grid grid-cols-2 md:grid-cols-3 gap-4">` +
                        questionData.options.map(option => `<div class="quiz-card bg-white p-4 rounded-lg shadow cursor-pointer border-2 border-transparent text-center" data-value="${option}"><span class="font-semibold">${option}</span></div>`).join('') + `</div>`;
                } else if (questionData.type === 'multi-select-tag') {
                    optionsHtml = `<div class="flex flex-wrap gap-3 justify-center">` +
                        questionData.options.map(option => `<button class="interest-tag bg-white py-2 px-4 rounded-full shadow border-2 border-slate-200 cursor-pointer" data-value="${option}">${option}</button>`).join('') + `</div>`;
                    nextBtn.classList.remove('hidden');
                }

                quizContainer.innerHTML = `<div class="question-wrapper active" id="question-${currentQuestionIndex}"><h3 class="text-2xl md:text-3xl font-bold text-center mb-8">${questionData.question}</h3>${optionsHtml}</div>`;
            };

            const handleAnswer = (e) => {
                const target = e.target.closest('[data-value]');
                if (!target) return;
                const value = target.dataset.value;
                const questionData = quizQuestions[currentQuestionIndex];

                if (questionData.type === 'single-choice-card') {
                    userAnswers[questionData.key] = value;
                    goToNextQuestion();
                } else if (questionData.type === 'multi-select-tag') {
                    userAnswers[questionData.key] = userAnswers[questionData.key] || [];
                    const selected = userAnswers[questionData.key];
                    if (selected.includes(value)) {
                        userAnswers[questionData.key] = selected.filter(i => i !== value);
                        target.classList.remove('selected');
                    } else if (selected.length < 3) {
                        userAnswers[questionData.key].push(value);
                        target.classList.add('selected');
                    }
                }
            };

            const goToNextQuestion = () => {
                const currentQuestionData = quizQuestions[currentQuestionIndex];
                if (currentQuestionData.type === 'text-input') {
                    userAnswers[currentQuestionData.key] = document.getElementById('text-input-field').value.trim();
                }

                const currentWrapper = document.getElementById(`question-${currentQuestionIndex}`);
                if (currentQuestionIndex < quizQuestions.length - 1) {
                    currentQuestionIndex++;
                    if (currentWrapper) {
                        currentWrapper.classList.add('exiting');
                        setTimeout(() => renderQuestion(), 500);
                    } else {
                        renderQuestion();
                    }
                } else {
                    showResults();
                }
            };
            
            const showResults = () => {
                const scoredProducts = products
                    .filter(p => p.status === 'active')
                    .map(product => {
                        let score = 0;
                        Object.entries(userAnswers).forEach(([key, value]) => {
                            if (product.tags[key]) {
                                const weight = (key === 'interests') ? 10 : 3;
                                if (Array.isArray(value)) {
                                    value.forEach(v => {
                                        if (product.tags[key].includes(v)) score += weight;
                                    });
                                } else {
                                    if (product.tags[key].includes(value) || product.tags[key].includes('alle')) {
                                        score += weight;
                                    }
                                }
                            }
                        });
                        return { ...product, score };
                    })
                    .sort((a, b) => b.score - a.score);

                resultsTitle.textContent = userAnswers.name ? `Gaveidéer til ${userAnswers.name}` : 'Her er vores forslag!';
                
                const topProduct = scoredProducts[0];

                let resultsHtml = '';
                if (topProduct) {
                    resultsHtml += createProductCard(topProduct, true);
                } else {
                    resultsHtml = `<p>Vi kunne desværre ikke finde et specifikt match. Prøv eventuelt igen med andre svar.</p>`;
                }
                
                resultsContainer.innerHTML = resultsHtml;
                switchView('results');
            };

            const createProductCard = (product) => {
                return `
                    <div class="bg-white rounded-lg shadow-xl max-w-md mx-auto text-left overflow-hidden">
                        <img src="${product.image}" alt="${product.name}" class="w-full h-64 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e2e8f0/475569?text=Billede+mangler';">
                        <div class="p-6">
                            <h3 class="text-2xl font-bold mb-2">${product.name}</h3>
                            <p class="text-slate-600 mb-4">${product.description}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-3xl font-bold text-slate-800">${product.price} kr.</span>
                                <a href="${product.url}" target="_blank" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 transition-colors">Se produkt</a>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-4 border-t">
                            <div class="mb-4">
                                <p class="text-sm font-semibold text-center mb-2">Hvor godt ramte vi plet?</p>
                                <div class="star-rating flex justify-center text-3xl" data-product-id="${product.id}">
                                    <button data-value="1">★</button><button data-value="2">★</button><button data-value="3">★</button><button data-value="4">★</button><button data-value="5">★</button>
                                </div>
                            </div>
                            <div class="text-center">
                                <button class="share-btn text-blue-600 font-semibold hover:underline">Del dit resultat -- eller spørg en ven om hjælp!</button>
                                <p class="share-feedback hidden text-sm text-green-600 mt-1">Link kopieret!</p>
                            </div>
                            <div class="text-xs text-slate-400 mt-4 text-right">
                                <button class="hover:underline report-btn" data-product-id="${product.id}">Rapportér et problem</button>
                            </div>
                        </div>
                    </div>`;
            };
            
            function handleModal(modalElement, openTriggers, closeTriggers) {
                openTriggers.forEach(trigger => trigger.addEventListener('click', () => modalElement.classList.add('visible')));
                closeTriggers.forEach(trigger => trigger.addEventListener('click', () => modalElement.classList.remove('visible')));
                modalElement.addEventListener('click', (e) => {
                    if (e.target === modalElement) modalElement.classList.remove('visible');
                });
            }

            handleModal(howItWorksModal, [document.getElementById('how-it-works-btn')], document.querySelectorAll('#how-it-works-modal .close-modal-btn'));
            handleModal(reportProblemModal, [], document.querySelectorAll('#report-problem-modal .close-modal-btn'));

            resultsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('report-btn')) {
                    currentReportProductId = e.target.dataset.productId;
                    reportOptions.classList.remove('hidden');
                    reportFeedback.classList.add('hidden');
                    reportProblemModal.classList.add('visible');
                }
                if (e.target.closest('.share-btn')) {
                    const feedback = e.target.nextElementSibling;
                    navigator.clipboard.writeText(window.location.href).then(() => {
                        feedback.classList.remove('hidden');
                        setTimeout(() => feedback.classList.add('hidden'), 2000);
                    });
                }
                if (e.target.closest('.star-rating button')) {
                    const button = e.target.closest('.star-rating button');
                    const rating = parseInt(button.dataset.value, 10);
                    const productId = parseInt(button.parentElement.dataset.productId, 10);
                    
                    const recommendedProduct = products.find(p => p.id === productId);

                    const feedbackData = {
                        rating_id: Date.now(),
                        product_id: productId,
                        product_name: recommendedProduct ? recommendedProduct.name : 'Unknown',
                        rating: rating,
                        quiz_answers: userAnswers,
                        timestamp: new Date().toISOString()
                    };

                    console.log("Rating Submitted (to be sent to ratings.json):", feedbackData);
                    
                    const stars = button.parentElement.querySelectorAll('button');
                    stars.forEach(star => {
                        star.classList.toggle('selected', star.dataset.value <= rating);
                    });
                    
                    stars.forEach(star => star.disabled = true);
                }
            });

            reportOptions.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const reportType = e.target.dataset.reportType;
                    
                    const flagData = {
                        flag_id: `f_${Date.now()}`,
                        product_id: parseInt(currentReportProductId, 10),
                        issue_type: reportType,
                        timestamp: new Date().toISOString(),
                        status: 'unresolved'
                    };

                    console.log(`Flag Submitted (to be sent to flags.json):`, flagData);

                    reportOptions.classList.add('hidden');
                    reportFeedback.classList.remove('hidden');
                    setTimeout(() => reportProblemModal.classList.remove('visible'), 1500);
                }
            });

            startQuizBtn.addEventListener('click', startQuiz);
            restartQuizBtn.addEventListener('click', () => switchView('landing'));
            quizContainer.addEventListener('click', handleAnswer);
            nextBtn.addEventListener('click', goToNextQuestion);
            earlyExitBtn.addEventListener('click', showResults);
        });
    </script>
</body>
</html>
