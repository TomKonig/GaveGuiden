<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Den Rette Gave Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .tab-btn.active { border-color: #4F46E5; color: #4F46E5; background-color: #EEF2FF; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-100">
    <div id="auth-view" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
            <h1 class="text-2xl font-bold text-center mb-6">Den Rette Gave Admin</h1>
            <input type="password" id="password-input" class="w-full p-3 border-2 border-slate-300 rounded-lg mb-4" placeholder="Password">
            <button id="login-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">Login</button>
            <p id="error-msg" class="text-red-500 text-sm text-center mt-4 hidden">Incorrect password.</p>
        </div>
    </div>

    <div id="admin-view" class="hidden p-4 md:p-8">
        <div id="alert-container" class="hidden mb-6 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert">
            <p class="font-bold">Alert!</p>
            <p id="alert-message">You have products with a high number of error reports.</p>
        </div>

        <h1 class="text-3xl font-bold text-slate-800 mb-6">Product Management</h1>
        
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-6" id="admin-tabs">
                <button class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="live-editor">Live Editor</button>
                <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="edit-product">Edit Product</button>
                <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="flagged-items">Flagged Items</button>
                <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="ratings">Ratings</button>
                <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="settings">Settings</button>
            </nav>
        </div>

        <div id="tab-content-container">
            <!-- Live Editor Tab -->
            <div id="live-editor" class="tab-content active">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-2">products.json Live Editor</h2>
                    <p class="text-slate-600 mb-4">This text area contains the full `products.json` content. Changes made in the "Edit Product" tab will be reflected here. When you are finished, copy this content and paste it into the file on GitHub.</p>
                    <textarea id="json-editor" class="w-full h-96 p-3 border-2 border-slate-300 rounded-lg font-mono text-sm"></textarea>
                    <div class="mt-4 flex gap-4">
                        <button id="copy-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700">Copy to Clipboard</button>
                        <span id="copy-feedback" class="text-green-600 self-center hidden">Copied!</span>
                    </div>
                </div>
            </div>

            <!-- Edit Product Tab -->
            <div id="edit-product" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4">Edit an Existing Product</h2>
                    <div class="mb-4">
                        <label for="product-selector" class="block text-sm font-medium text-gray-700">Select a Product</label>
                        <select id="product-selector" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div id="edit-form-container" class="hidden space-y-4">
                        <div><label class="block font-medium">Name</label><input type="text" id="edit-name" class="w-full p-2 border rounded"></div>
                        <div><label class="block font-medium">Description</label><textarea id="edit-description" class="w-full p-2 border rounded h-24"></textarea></div>
                        <div><label class="block font-medium">Price</label><input type="number" id="edit-price" class="w-full p-2 border rounded"></div>
                        <div><label class="block font-medium">Image URL</label><input type="text" id="edit-image" class="w-full p-2 border rounded"></div>
                        <div><label class="block font-medium">Tags (comma-separated)</label><input type="text" id="edit-tags-interests" class="w-full p-2 border rounded"></div>
                        <button id="save-changes-btn" class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-green-700">Update in Editor</button>
                        <span id="save-feedback" class="text-green-600 self-center hidden ml-4">Updated!</span>
                    </div>
                </div>
            </div>

            <!-- Flagged Items Tab -->
            <div id="flagged-items" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">User Reported Flags</h2>
                        <div class="flex items-center gap-2">
                            <label for="threshold-input" class="text-sm font-medium">Alert Threshold:</label>
                            <input type="number" id="threshold-input" value="3" class="w-20 p-1 border rounded">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issue Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reports</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Reported</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody id="flags-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Ratings Tab -->
            <div id="ratings" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4">User Ratings & Feedback</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rating</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quiz Answers</th>
                                </tr>
                            </thead>
                            <tbody id="ratings-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4">Admin Settings</h2>
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Change Admin Password</h3>
                            <p class="text-slate-600 mt-2 mb-4">For security, your password is not stored in our code. It is managed as an "environment variable" in your Netlify hosting settings. To change it, please follow these steps:</p>
                            <ol class="list-decimal list-inside text-slate-600 space-y-2">
                                <li>Log in to your account at <a href="https://www.netlify.com/" target="_blank" class="text-blue-600 hover:underline">Netlify.com</a>.</li>
                                <li>Navigate to your "Den Rette Gave" site dashboard.</li>
                                <li>Go to **Site settings > Build & deploy > Environment**.</li>
                                <li>Under **Environment variables**, you will see a variable named `ADMIN_PASSWORD`.</li>
                                <li>Click **Edit** and enter your new desired password in the value field.</li>
                                <li>Click **Save**. You will need to trigger a new deploy for the change to take effect.</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    const loginView = document.getElementById('login-view');
    const adminView = document.getElementById('admin-view');
    const passwordInput = document.getElementById('password');
    const loginButton = document.getElementById('login-button');
    const loginError = document.getElementById('login-error');
    const jsonEditor = document.getElementById('json-editor');
    const copyButton = document.getElementById('copy-button');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const productSelector = document.getElementById('product-selector');
    const editForm = document.getElementById('edit-form');

    // Check for existing token
    const token = localStorage.getItem('jwt_token');
    if (token) {
        // You might want to validate the token here
        loginView.classList.add('hidden');
        adminView.classList.remove('hidden');
        loadAdminData();
    }

    loginButton.addEventListener('click', async () => {
        const password = passwordInput.value;
        loginError.classList.add('hidden');

        try {
            const response = await fetch('/api/admin-login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });

            if (!response.ok) {
                throw new Error('Login failed');
            }

            const { token } = await response.json();
            localStorage.setItem('jwt_token', token);

            loginView.classList.add('hidden');
            adminView.classList.remove('hidden');
            loadAdminData();
        } catch (error) {
            loginError.textContent = 'Invalid password.';
            loginError.classList.remove('hidden');
        }
    });

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('border-indigo-500', 'text-indigo-600'));
            tab.classList.add('border-indigo-500', 'text-indigo-600');

            tabContents.forEach(content => {
                if (content.id === `${tab.dataset.tab}-content`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
        });
    });

    async function loadAdminData() {
        // Load data for all tabs
        loadLiveEditor();
        loadFlags();
        loadRatings();
    }

    async function loadLiveEditor() {
        try {
            const response = await fetch('/assets/products.json');
            const products = await response.json();
            jsonEditor.value = JSON.stringify(products, null, 2);
            populateProductSelector(products);
        } catch (error) {
            console.error('Error loading products.json:', error);
            jsonEditor.value = 'Error loading products.json.';
        }
    }

    copyButton.addEventListener('click', () => {
        jsonEditor.select();
        document.execCommand('copy');
        copyButton.textContent = 'Copied!';
        setTimeout(() => { copyButton.textContent = 'Copy to Clipboard'; }, 2000);
    });
    
    // --- THIS IS THE UPDATED FUNCTION ---
    async function loadFlags() {
        const flagsTableBody = document.getElementById('flags-table-body');
        const flagsLoading = document.getElementById('flags-loading');
        const flagsError = document.getElementById('flags-error');
        flagsLoading.classList.remove('hidden');
        flagsError.classList.add('hidden');
        flagsTableBody.innerHTML = '';

        try {
            const token = localStorage.getItem('jwt_token');
            if (!token) throw new Error('Not authenticated');

            const response = await fetch('/api/get-flags', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                throw new Error(`Failed to fetch flags. Status: ${response.status}`);
            }
            const flags = await response.json();

            // Aggregate flags by productId
            const flagCounts = flags.reduce((acc, flag) => {
                acc[flag.productId] = (acc[flag.productId] || 0) + 1;
                return acc;
            }, {});

            const productsResponse = await fetch('/assets/products.json');
            const products = await productsResponse.json();
            const productMap = products.reduce((acc, p) => {
                acc[p.id] = p.name;
                return acc;
            }, {});

            flagsTableBody.innerHTML = ''; // Clear existing rows
            Object.entries(flagCounts).forEach(([productId, count]) => {
                const productName = productMap[productId] || 'Unknown Product';
                const row = `
                    <tr>
                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">${productName} (ID: ${productId})</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${count}</td>
                        <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                            <a href="#" class="text-indigo-600 hover:text-indigo-900">Resolve<span class="sr-only">, ${productName}</span></a>
                        </td>
                    </tr>
                `;
                flagsTableBody.innerHTML += row;
            });

        } catch (error) {
            console.error('Error loading flags:', error);
            flagsError.classList.remove('hidden');
        } finally {
            flagsLoading.classList.add('hidden');
        }
    }
    
    async function loadRatings() {
        const ratingsContent = document.getElementById('ratings-content-body');
        ratingsContent.innerHTML = 'Loading ratings...';
        
        try {
            const token = localStorage.getItem('jwt_token');
            if (!token) throw new Error('Not authenticated');
            
            const response = await fetch('/api/get-ratings', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error('Failed to fetch ratings');

            const ratings = await response.json();

            const productsResponse = await fetch('/assets/products.json');
            const products = await productsResponse.json();
            const productMap = products.reduce((acc, p) => {
                acc[p.id] = p.name;
                return acc;
            }, {});

            // Calculate average ratings
            const averageRatings = ratings.reduce((acc, rating) => {
                if (!acc[rating.productId]) {
                    acc[rating.productId] = { total: 0, count: 0 };
                }
                acc[rating.productId].total += rating.rating;
                acc[rating.productId].count += 1;
                return acc;
            }, {});
            
            ratingsContent.innerHTML = '';
            for (const productId in averageRatings) {
                const avg = (averageRatings[productId].total / averageRatings[productId].count).toFixed(2);
                const productName = productMap[productId] || 'Unknown Product';
                const div = document.createElement('div');
                div.className = 'p-4 border rounded-lg';
                div.innerHTML = `<h4 class="font-semibold">${productName}</h4><p>Average Rating: ${avg} / 5</p><p>Based on ${averageRatings[productId].count} ratings.</p>`;
                ratingsContent.appendChild(div);
            }

        } catch(e) {
            ratingsContent.innerHTML = `<p class="text-red-500">Error loading ratings. ${e.message}</p>`;
        }
    }

    function populateProductSelector(products) {
        productSelector.innerHTML = '<option>Select a product to edit...</option>';
        products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = product.name;
            productSelector.appendChild(option);
        });
    }

    productSelector.addEventListener('change', async (e) => {
        const productId = e.target.value;
        if (!productId) {
            editForm.classList.add('hidden');
            return;
        }

        const response = await fetch('/assets/products.json');
        const products = await response.json();
        const product = products.find(p => p.id === productId);

        if (product) {
            document.getElementById('edit-id').value = product.id;
            document.getElementById('edit-name').value = product.name;
            document.getElementById('edit-description').value = product.description;
            document.getElementById('edit-price').value = product.price;
            document.getElementById('edit-url').value = product.url;
            document.getElementById('edit-image').value = product.image;
            document.getElementById('edit-tags').value = product.tags.join(', ');
            document.getElementById('edit-differentiator_tags').value = product.differentiator_tags ? product.differentiator_tags.join(', ') : '';
            document.getElementById('edit-status').value = product.status;
            editForm.classList.remove('hidden');
        }
    });

    document.getElementById('save-edit-button').addEventListener('click', () => {
        const productId = document.getElementById('edit-id').value;
        const products = JSON.parse(jsonEditor.value);
        const productIndex = products.findIndex(p => p.id === productId);

        if (productIndex > -1) {
            products[productIndex] = {
                id: document.getElementById('edit-id').value,
                name: document.getElementById('edit-name').value,
                description: document.getElementById('edit-description').value,
                price: parseFloat(document.getElementById('edit-price').value),
                url: document.getElementById('edit-url').value,
                image: document.getElementById('edit-image').value,
                tags: document.getElementById('edit-tags').value.split(',').map(t => t.trim()),
                differentiator_tags: document.getElementById('edit-differentiator_tags').value.split(',').map(t => t.trim()),
                status: document.getElementById('edit-status').value,
            };
            jsonEditor.value = JSON.stringify(products, null, 2);
            alert('Changes applied to the Live Editor. Copy to clipboard and save to GitHub.');
        }
    });
</script>
</body>
</html>
