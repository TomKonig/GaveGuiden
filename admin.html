<script>
    // --- DOM elements ---
    const loginView = document.getElementById('login-view');
    const adminView = document.getElementById('admin-view');
    const passwordInput = document.getElementById('password');
    const loginButton = document.getElementById('login-button');
    const logoutButton = document.getElementById('logout-button'); // New button
    const loginError = document.getElementById('login-error');
    const jsonEditor = document.getElementById('json-editor');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const productSelector = document.getElementById('product-selector');
    const editForm = document.getElementById('edit-form');
    const saveGitHubButton = document.getElementById('save-github-button');
    const saveStatus = document.getElementById('save-status');
    const flagsTableBody = document.getElementById('flags-table-body');

    // --- NEW AUTH FLOW ---
    async function checkAuthentication() {
        try {
            const response = await fetch('/api/check-auth');
            if (response.ok) {
                showAdminPanel();
            } else {
                showLoginPanel();
            }
        } catch (error) {
            showLoginPanel();
        }
    }

    function showAdminPanel() {
        loginView.classList.add('hidden');
        adminView.classList.remove('hidden');
        loadAdminData();
    }

    function showLoginPanel() {
        loginView.classList.remove('hidden');
        adminView.classList.add('hidden');
    }

    loginButton.addEventListener('click', async () => {
        const password = passwordInput.value;
        loginError.classList.add('hidden');
        try {
            const response = await fetch('/api/admin-login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            if (!response.ok) throw new Error('Login failed');
            showAdminPanel();
        } catch (error) {
            loginError.textContent = 'Invalid password.';
            loginError.classList.remove('hidden');
        }
    });

    logoutButton.addEventListener('click', async () => {
        await fetch('/api/admin-logout');
        showLoginPanel();
    });

    // Initial check on page load
    document.addEventListener('DOMContentLoaded', checkAuthentication);

    // --- All other functions (loadAdminData, loadFlags, etc.) remain the same,
    // but their fetch calls no longer need the Authorization header.
    // The browser handles sending the cookie automatically.
    
    // Example of an updated fetch call in loadFlags:
    async function loadFlags() {
        // ...
        try {
            // NO 'Authorization' header needed anymore!
            const response = await fetch('/api/get-flags'); 
            // ...
        } catch (error) {
            // ...
        }
    }
</script>
