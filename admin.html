<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Den Rette Gave Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .tab-btn.active { border-color: #4F46E5; color: #4F46E5; background-color: #EEF2FF; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-100">
    <div id="auth-view" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
            <h1 class="text-2xl font-bold text-center mb-6">Den Rette Gave Admin</h1>
            <input type="password" id="password-input" class="w-full p-3 border-2 border-slate-300 rounded-lg mb-4" placeholder="Password">
            <button id="login-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">Login</button>
            <p id="error-msg" class="text-red-500 text-sm text-center mt-4 hidden">Incorrect password.</p>
        </div>
    </div>

    <div id="admin-view" class="hidden p-4 md:p-8">
        <div id="alert-container" class="hidden mb-6 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert">
            <p class="font-bold">Alert!</p>
            <p id="alert-message">You have products with a high number of error reports.</p>
        </div>

        <h1 class="text-3xl font-bold text-slate-800 mb-6">Product Management</h1>
        
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-6" id="admin-tabs">
                <button class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="live-editor">Live Editor</button>
                <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="edit-product">Edit Product</button>
                <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="flagged-items">Flagged Items</button>
                <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="ratings">Ratings</button>
                <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="settings">Settings</button>
            </nav>
        </div>

        <div id="tab-content-container">
            <!-- Live Editor Tab -->
            <div id="live-editor" class="tab-content active">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-2">products.json Live Editor</h2>
                    <p class="text-slate-600 mb-4">This text area contains the full `products.json` content. Changes made in the "Edit Product" tab will be reflected here. When you are finished, copy this content and paste it into the file on GitHub.</p>
                    <textarea id="json-editor" class="w-full h-96 p-3 border-2 border-slate-300 rounded-lg font-mono text-sm"></textarea>
                    <div class="mt-4 flex gap-4">
                        <button id="copy-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700">Copy to Clipboard</button>
                        <span id="copy-feedback" class="text-green-600 self-center hidden">Copied!</span>
                    </div>
                </div>
            </div>

            <!-- Edit Product Tab -->
            <div id="edit-product" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4">Edit an Existing Product</h2>
                    <div class="mb-4">
                        <label for="product-selector" class="block text-sm font-medium text-gray-700">Select a Product</label>
                        <select id="product-selector" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div id="edit-form-container" class="hidden space-y-4">
                        <div><label class="block font-medium">Name</label><input type="text" id="edit-name" class="w-full p-2 border rounded"></div>
                        <div><label class="block font-medium">Description</label><textarea id="edit-description" class="w-full p-2 border rounded h-24"></textarea></div>
                        <div><label class="block font-medium">Price</label><input type="number" id="edit-price" class="w-full p-2 border rounded"></div>
                        <div><label class="block font-medium">Image URL</label><input type="text" id="edit-image" class="w-full p-2 border rounded"></div>
                        <div><label class="block font-medium">Tags (comma-separated)</label><input type="text" id="edit-tags-interests" class="w-full p-2 border rounded"></div>
                        <button id="save-changes-btn" class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-green-700">Update in Editor</button>
                        <span id="save-feedback" class="text-green-600 self-center hidden ml-4">Updated!</span>
                    </div>
                </div>
            </div>

            <!-- Flagged Items Tab -->
            <div id="flagged-items" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">User Reported Flags</h2>
                        <div class="flex items-center gap-2">
                            <label for="threshold-input" class="text-sm font-medium">Alert Threshold:</label>
                            <input type="number" id="threshold-input" value="3" class="w-20 p-1 border rounded">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issue Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reports</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Reported</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody id="flags-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Ratings Tab -->
            <div id="ratings" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4">User Ratings & Feedback</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rating</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quiz Answers</th>
                                </tr>
                            </thead>
                            <tbody id="ratings-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4">Admin Settings</h2>
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Change Admin Password</h3>
                            <p class="text-slate-600 mt-2 mb-4">For security, your password is not stored in our code. It is managed as an "environment variable" in your Netlify hosting settings. To change it, please follow these steps:</p>
                            <ol class="list-decimal list-inside text-slate-600 space-y-2">
                                <li>Log in to your account at <a href="https://www.netlify.com/" target="_blank" class="text-blue-600 hover:underline">Netlify.com</a>.</li>
                                <li>Navigate to your "Den Rette Gave" site dashboard.</li>
                                <li>Go to **Site settings > Build & deploy > Environment**.</li>
                                <li>Under **Environment variables**, you will see a variable named `ADMIN_PASSWORD`.</li>
                                <li>Click **Edit** and enter your new desired password in the value field.</li>
                                <li>Click **Save**. You will need to trigger a new deploy for the change to take effect.</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const authView = document.getElementById('auth-view');
            const adminView = document.getElementById('admin-view');
            const passwordInput = document.getElementById('password-input');
            const loginBtn = document.getElementById('login-btn');
            const errorMsg = document.getElementById('error-msg');
            const jsonEditor = document.getElementById('json-editor');
            const copyBtn = document.getElementById('copy-btn');
            const copyFeedback = document.getElementById('copy-feedback');
            const tabs = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const productSelector = document.getElementById('product-selector');
            const editFormContainer = document.getElementById('edit-form-container');
            const saveChangesBtn = document.getElementById('save-changes-btn');
            const saveFeedback = document.getElementById('save-feedback');
            const flagsTableBody = document.getElementById('flags-table-body');
            const thresholdInput = document.getElementById('threshold-input');
            const alertContainer = document.getElementById('alert-container');
            const ratingsTableBody = document.getElementById('ratings-table-body');

            let productData = [];
            let flagsData = [];
            let ratingsData = [];
            let authToken = null;

            async function login() {
                const password = passwordInput.value;
                errorMsg.classList.add('hidden');
                loginBtn.disabled = true;
                loginBtn.textContent = 'Logging in...';

                try {
                    const response = await fetch('/.netlify/functions/admin-login', {
                        method: 'POST',
                        body: JSON.stringify({ password })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        authToken = data.token;
                        sessionStorage.setItem('drg-auth-token', authToken);
                        authView.classList.add('hidden');
                        adminView.classList.remove('hidden');
                        await loadAllData();
                    } else {
                        errorMsg.classList.remove('hidden');
                    }
                } catch (err) {
                    console.error("Login request failed:", err);
                    errorMsg.textContent = "An error occurred. Please try again.";
                    errorMsg.classList.remove('hidden');
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Login';
                }
            }

            async function loadAllData() {
                if (!authToken) return;
                try {
                    const [productsRes, flagsRes, ratingsRes] = await Promise.all([
                        fetch('./assets/products.json'),
                        fetch('./assets/flags.json'),
                        fetch('/.netlify/functions/get-ratings', {
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        })
                    ]);
                    
                    if (!productsRes.ok) throw new Error('Failed to fetch products');
                    productData = await productsRes.json();
                    
                    flagsData = flagsRes.ok ? await flagsRes.json() : [];
                    
                    if (ratingsRes.ok) {
                        ratingsData = await ratingsRes.json();
                    } else {
                        console.warn('Could not fetch ratings, maybe unauthorized or error.');
                        ratingsData = [];
                    }
                    
                    jsonEditor.value = JSON.stringify(productData, null, 2);
                    populateProductSelector();
                    renderFlags();
                    renderRatings();

                } catch (error) {
                    console.error("Error loading data:", error);
                    alert("Failed to load critical data. Please check the console for errors.");
                }
            }
            
            function renderFlags() {
                if (!flagsData) return;
                const threshold = parseInt(thresholdInput.value) || 3;
                let highAlert = false;

                const aggregatedFlags = flagsData
                    .filter(flag => flag.status === 'unresolved')
                    .reduce((acc, flag) => {
                        const key = `${flag.product_id}-${flag.issue_type}`;
                        if (!acc[key]) {
                            acc[key] = { product_id: flag.product_id, issue_type: flag.issue_type, reports: 0, last_reported: '1970-01-01T00:00:00Z', flag_ids: [] };
                        }
                        acc[key].reports++;
                        if (flag.timestamp > acc[key].last_reported) acc[key].last_reported = flag.timestamp;
                        acc[key].flag_ids.push(flag.flag_id);
                        return acc;
                    }, {});

                flagsTableBody.innerHTML = '';
                const sortedFlags = Object.values(aggregatedFlags).sort((a, b) => b.reports - a.reports);

                if (sortedFlags.length === 0) {
                     flagsTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No unresolved flags found.</td></tr>`;
                     alertContainer.classList.add('hidden');
                     return;
                }

                sortedFlags.forEach(aggFlag => {
                    const product = productData.find(p => p.id === aggFlag.product_id);
                    const productName = product ? `${product.id}: ${product.name}` : `Unknown (ID: ${aggFlag.product_id})`;
                    const lastReportedDate = new Date(aggFlag.last_reported).toLocaleString('da-DK');
                    if (aggFlag.reports >= threshold) highAlert = true;
                    const row = `<tr class="${aggFlag.reports >= threshold ? 'bg-red-50' : ''}"><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${productName}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${aggFlag.issue_type}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${aggFlag.reports}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lastReportedDate}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium"><button class="text-indigo-600 hover:text-indigo-900 resolve-btn" data-flag-ids='${JSON.stringify(aggFlag.flag_ids)}'>Resolve</button></td></tr>`;
                    flagsTableBody.innerHTML += row;
                });
                alertContainer.classList.toggle('hidden', !highAlert);
            }
            
            function renderRatings() {
                if (!ratingsData || ratingsData.length === 0) {
                    ratingsTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No ratings submitted yet.</td></tr>`;
                    return;
                }
                ratingsTableBody.innerHTML = '';
                ratingsData.slice().reverse().forEach(rating => {
                    const ratingDate = new Date(rating.timestamp).toLocaleString('da-DK');
                    const answers = JSON.stringify(rating.quiz_answers, null, 2);
                    const row = `<tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${rating.product_name}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-yellow-500 font-bold">${'★'.repeat(rating.rating)}${'☆'.repeat(5 - rating.rating)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ratingDate}</td><td class="px-6 py-4 text-xs text-gray-500"><pre>${answers}</pre></td></tr>`;
                    ratingsTableBody.innerHTML += row;
                });
            }
            
            function populateProductSelector() {
                productSelector.innerHTML = '<option value="-1">-- Vælg et produkt --</option>';
                productData.forEach((product, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${product.id}: ${product.name}`;
                    productSelector.appendChild(option);
                });
            }

            // Check for existing token on page load
            authToken = sessionStorage.getItem('drg-auth-token');
            if (authToken) {
                authView.classList.add('hidden');
                adminView.classList.remove('hidden');
                loadAllData();
            }

            loginBtn.addEventListener('click', login);
            passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') login(); });

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    tabContents.forEach(c => c.classList.toggle('active', c.id === tab.dataset.tab));
                });
            });

            // ... (rest of the event listeners for copy, edit, resolve, etc.)
        });
    </script>
</body>
</html>
