<script>
    // --- Existing DOM elements ---
    const loginView = document.getElementById('login-view');
    const adminView = document.getElementById('admin-view');
    const passwordInput = document.getElementById('password');
    const loginButton = document.getElementById('login-button');
    const loginError = document.getElementById('login-error');
    const jsonEditor = document.getElementById('json-editor');
    // const copyButton = document.getElementById('copy-button'); // No longer needed
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const productSelector = document.getElementById('product-selector');
    const editForm = document.getElementById('edit-form');
    // --- New elements for save functionality ---
    const saveGitHubButton = document.getElementById('save-github-button');
    const saveStatus = document.getElementById('save-status');


    // Check for existing token
    const token = localStorage.getItem('jwt_token');
    if (token) {
        loginView.classList.add('hidden');
        adminView.classList.remove('hidden');
        loadAdminData();
    }

    loginButton.addEventListener('click', async () => {
        const password = passwordInput.value;
        loginError.classList.add('hidden');

        try {
            const response = await fetch('/api/admin-login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });

            if (!response.ok) throw new Error('Login failed');

            const { token } = await response.json();
            localStorage.setItem('jwt_token', token);

            loginView.classList.add('hidden');
            adminView.classList.remove('hidden');
            loadAdminData();
        } catch (error) {
            loginError.textContent = 'Invalid password.';
            loginError.classList.remove('hidden');
        }
    });

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('border-indigo-500', 'text-indigo-600'));
            tab.classList.add('border-indigo-500', 'text-indigo-600');

            tabContents.forEach(content => {
                content.id === `${tab.dataset.tab}-content` ? content.classList.remove('hidden') : content.classList.add('hidden');
            });
        });
    });

    async function loadAdminData() {
        loadLiveEditor();
        loadFlags();
        loadRatings();
    }

    async function loadLiveEditor() {
        try {
            const response = await fetch('/assets/products.json');
            const products = await response.json();
            // Use a pretty-printed version for readability
            jsonEditor.value = JSON.stringify(products, null, 2);
            populateProductSelector(products);
        } catch (error) {
            console.error('Error loading products.json:', error);
            jsonEditor.value = 'Error loading products.json.';
        }
    }

    // --- NEW SAVE FUNCTIONALITY ---
    saveGitHubButton.addEventListener('click', async () => {
        if (!confirm('Are you sure you want to save these changes directly to the live site?')) {
            return;
        }

        saveStatus.classList.remove('hidden', 'text-green-600', 'text-red-600');
        saveStatus.textContent = 'Saving to GitHub...';
        saveGitHubButton.disabled = true;

        const token = localStorage.getItem('jwt_token');
        const content = jsonEditor.value;

        try {
            // Validate JSON before sending
            JSON.parse(content);

            const response = await fetch('/api/update-products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ content })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to save.');
            }

            const result = await response.json();
            saveStatus.textContent = result.message;
            saveStatus.classList.add('text-green-600');

        } catch (error) {
            saveStatus.textContent = `Error: ${error.message}`;
            saveStatus.classList.add('text-red-600');
             if (error instanceof SyntaxError) {
                saveStatus.textContent = 'Error: The content is not valid JSON.';
            }
        } finally {
            saveGitHubButton.disabled = false;
        }
    });


    // --- UNCHANGED FUNCTIONS (loadFlags, loadRatings, etc.) ---
    async function loadFlags() {
        const flagsTableBody = document.getElementById('flags-table-body');
        const flagsLoading = document.getElementById('flags-loading');
        const flagsError = document.getElementById('flags-error');
        flagsLoading.classList.remove('hidden');
        flagsError.classList.add('hidden');
        flagsTableBody.innerHTML = '';

        try {
            const token = localStorage.getItem('jwt_token');
            if (!token) throw new Error('Not authenticated');

            const response = await fetch('/api/get-flags', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error(`Failed to fetch flags. Status: ${response.status}`);
            
            const flags = await response.json();
            const flagCounts = flags.reduce((acc, flag) => {
                acc[flag.productId] = (acc[flag.productId] || 0) + 1;
                return acc;
            }, {});

            const productsResponse = await fetch('/assets/products.json');
            const products = await productsResponse.json();
            const productMap = products.reduce((acc, p) => {
                acc[p.id] = p.name;
                return acc;
            }, {});

            flagsTableBody.innerHTML = ''; // Clear existing rows
            Object.entries(flagCounts).forEach(([productId, count]) => {
                const productName = productMap[productId] || 'Unknown Product';
                const row = `
                    <tr>
                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">${productName} (ID: ${productId})</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${count}</td>
                        <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                            <a href="#" class="text-indigo-600 hover:text-indigo-900">Resolve<span class="sr-only">, ${productName}</span></a>
                        </td>
                    </tr>
                `;
                flagsTableBody.innerHTML += row;
            });

        } catch (error) {
            console.error('Error loading flags:', error);
            flagsError.classList.remove('hidden');
        } finally {
            flagsLoading.classList.add('hidden');
        }
    }
    
    async function loadRatings() {
        // ... (this function remains unchanged)
    }

    function populateProductSelector(products) {
        // ... (this function remains unchanged)
    }

    productSelector.addEventListener('change', async (e) => {
        // ... (this function remains unchanged)
    });

    document.getElementById('save-edit-button').addEventListener('click', () => {
        const productId = document.getElementById('edit-id').value;
        const products = JSON.parse(jsonEditor.value);
        const productIndex = products.findIndex(p => p.id === productId);

        if (productIndex > -1) {
            products[productIndex] = {
                id: document.getElementById('edit-id').value,
                name: document.getElementById('edit-name').value,
                description: document.getElementById('edit-description').value,
                price: parseFloat(document.getElementById('edit-price').value),
                url: document.getElementById('edit-url').value,
                image: document.getElementById('edit-image').value,
                tags: document.getElementById('edit-tags').value.split(',').map(t => t.trim()).filter(Boolean),
                differentiator_tags: document.getElementById('edit-differentiator_tags').value.split(',').map(t => t.trim()).filter(Boolean),
                status: document.getElementById('edit-status').value,
            };
            jsonEditor.value = JSON.stringify(products, null, 2);
            // Switch to the Live Editor tab to show the changes
            document.querySelector('.tab[data-tab="live-editor"]').click();
            alert('Changes applied to the Live Editor. Review them and click "Save to GitHub" to make them live.');
        }
    });
</script>
